name: Node.js CI

on:
    push:
        branches: ["main"]
    pull_request:
        branches: ["main"]

jobs:
    build:
        runs-on: self-hosted
        strategy:
            matrix:
                node-version: [14, 16, 18]
        name: Use Node.js ${{ matrix.node-version }}
        steps:
            - uses: actions/checkout@v3
            - name: Create env file
              run: |
                  echo "${{ secrets.ENV_FILE }}" | base64 -d > ./server/.env
            - name: Install pnpm
              uses: pnpm/action-setup@v2
              with:
                  version: 6.0.2
            - name: Build Docker image
              run: docker-compose -f "docker-compose.yaml" up -d --build
            - name: Install dependencies
              run: pnpm install -r
            - name: Build app
              run: pnpm --if-present run build
            - name: Run tests
              run: pnpm --if-present run test
            - name: Clean up
              run: docker-compose -f "docker-compose.yaml" down

              
concurrency:
    group: ${{ github.head_ref }}
    cancel-in-progress: true
